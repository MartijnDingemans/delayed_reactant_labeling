<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Extensive example &mdash; Delayed-Reactant-Labeling 0.2.5 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js?v=e9ffd43a"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="_static/copybutton.js?v=f281be69"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Implementation details" href="design_choices.html" />
    <link rel="prev" title="Visualize" href="visualize.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Delayed-Reactant-Labeling
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="predict.html">Predict</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimize.html">Optimize</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualize.html">Visualize</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Extensive example</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#experimental-data">Experimental data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#defining-the-error-metric">Defining the error metric</a></li>
<li class="toctree-l2"><a class="reference internal" href="#utilizing-normal-kinetics">Utilizing normal kinetics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#defining-the-model">Defining the model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#optimizing-the-model">Optimizing the model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#visualize">Visualize</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#model-progression">Model progression</a></li>
<li class="toctree-l3"><a class="reference internal" href="#model-output">Model output</a></li>
<li class="toctree-l3"><a class="reference internal" href="#heat-maps">Heat maps</a></li>
<li class="toctree-l3"><a class="reference internal" href="#error-curves">Error curves</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multiple-guesses">Multiple guesses</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="design_choices.html">Implementation details</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Delayed-Reactant-Labeling</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Extensive example</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/extensive_example.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="extensive-example">
<h1>Extensive example<a class="headerlink" href="#extensive-example" title="Permalink to this heading"></a></h1>
<p>Hilgers et al. (<a class="reference external" href="https://onlinelibrary.wiley.com/doi/full/10.1002/anie.202205720">link</a>, <cite>DOI: doi/10.1002/anie.202205720</cite>)
used DRL to analyze a reaction with the following mechanism:</p>
<a class="reference internal image-reference" href="_images/Hilgers_mechanism.png"><img alt="_images/Hilgers_mechanism.png" class="align-center" src="_images/Hilgers_mechanism.png" style="width: 400px;" /></a>
<p>There are 3 isomers per intermediate in this reaction:</p>
<a class="reference internal image-reference" href="_images/Hilgers_isomers.jpeg"><img alt="_images/Hilgers_isomers.jpeg" class="align-center" src="_images/Hilgers_isomers.jpeg" style="width: 800px;" /></a>
<p>Below I will describe how we can analyze their data using the delayed_reactant_labeling module. However, to make the
analysis easier we have changed the naming convention. The major pathway <code class="docutils literal notranslate"><span class="pre">3C</span> <span class="pre">-&gt;</span> <span class="pre">4B</span> <span class="pre">-&gt;</span> <span class="pre">5B</span> <span class="pre">-&gt;</span> <span class="pre">R6</span></code> and minor pathway
<code class="docutils literal notranslate"><span class="pre">3B</span> <span class="pre">-&gt;</span> <span class="pre">4C</span> <span class="pre">-&gt;</span> <span class="pre">5C</span> <span class="pre">-&gt;</span> <span class="pre">S6</span></code> is quite confusing as the label of the isomer changes for the same pathway. Therefore all intermediates
in the major pathway have been labeled with “D”, and in the minor pathway with “E”. All intermediates in the side pathway
“A” have been labeled “F”. The data adjusted for this naming convention, and with time array extending for the
data pre-addition of the labeled compound can be found on <a class="reference external" href="https://github.com/MartijnDingemans/delayed_reactant_labeling/tree/5a06b113895e3c8b324220486a59d7510bd77bf1/examples">github</a>.</p>
<section id="experimental-data">
<h2>Experimental data<a class="headerlink" href="#experimental-data" title="Permalink to this heading"></a></h2>
<p>First we import the required modules, and show the original data around the time that the labeled compound has been added</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span><span class="p">,</span> <span class="n">Bounds</span>
<span class="kn">from</span> <span class="nn">delayed_reactant_labeling.optimize</span> <span class="kn">import</span> <span class="n">RateConstantOptimizerTemplate</span>
<span class="kn">from</span> <span class="nn">delayed_reactant_labeling.predict</span> <span class="kn">import</span> <span class="n">DRL</span>

<span class="n">experimental_complete</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s1">&#39;experimental_data_Hilgers.xlsx&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">)</span>
<span class="n">LABEL</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span>  <span class="c1"># single &#39; was used for labeled reactants. To keep the code general, we will use LABEL instead.</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">experimental_complete</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="s1">&#39;time (min)&#39;</span> <span class="ow">or</span> <span class="n">col</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">LABEL</span><span class="p">):]</span> <span class="o">==</span> <span class="n">LABEL</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">experimental_complete</span><span class="p">[</span><span class="s1">&#39;time (min)&#39;</span><span class="p">],</span> <span class="n">experimental_complete</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">experimental_complete</span><span class="p">[</span><span class="s1">&#39;time (min)&#39;</span><span class="p">],</span> <span class="n">experimental_complete</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}{</span><span class="n">LABEL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}{</span><span class="n">LABEL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;normalized intensity w.r.t. TIC&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (min)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">10.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/overview.png"><img alt="_images/overview.png" class="align-center" src="_images/overview.png" style="width: 600px;" /></a>
<p>We can clearly see that around 10.15 minutes the intensity of 3D’ increases rapidly. Therefore, we can assume this to
be t0. Furthermore we see that the labeled compounds (dashed lines) have intensities before the chemicals should
be present due to inherent noise. We can correct our data according for these two factors as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">experimental_complete</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;time (min)&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;3D</span><span class="si">{</span><span class="n">LABEL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">TIME_LABELED_ADDITION</span> <span class="o">=</span> <span class="mf">10.15</span>
<span class="n">index_labeled_addition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">experimental_complete</span><span class="p">[</span><span class="s1">&#39;time (min)&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">TIME_LABELED_ADDITION</span><span class="p">))</span>  <span class="c1"># select first true value</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">experimental_complete</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>  <span class="c1"># correct for noise by removing the median</span>
    <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="s1">&#39;time (min)&#39;</span> <span class="ow">or</span> <span class="n">col</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">LABEL</span><span class="p">):]</span> <span class="o">!=</span> <span class="n">LABEL</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">experimental_complete</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">experimental_complete</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> \
        <span class="o">-</span> <span class="n">experimental_complete</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_labeled_addition</span><span class="o">-</span><span class="mi">10</span><span class="p">:</span><span class="n">index_labeled_addition</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

<span class="n">experimental_complete</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;time (min)&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;3D</span><span class="si">{</span><span class="n">LABEL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;3D</span><span class="si">{</span><span class="n">LABEL</span><span class="si">}</span><span class="s1"> corrected&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">10.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">time_pre</span> <span class="o">=</span> <span class="n">experimental_complete</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">index_labeled_addition</span><span class="p">,</span> <span class="s1">&#39;time (min)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># pre addition</span>
<span class="n">experimental</span> <span class="o">=</span> <span class="n">experimental_complete</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_labeled_addition</span><span class="p">:,</span> <span class="p">:]</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">experimental</span><span class="p">[</span><span class="s1">&#39;time (min)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/overview_corrected.png"><img alt="_images/overview_corrected.png" class="align-center" src="_images/overview_corrected.png" style="width: 600px;" /></a>
</section>
<section id="defining-the-error-metric">
<h2>Defining the error metric<a class="headerlink" href="#defining-the-error-metric" title="Permalink to this heading"></a></h2>
<p>For a typical DRL experiment, the initial part of the curve is the most important, as this is where the largest changes occur.
When we optimize the model, we can weigh these initial parts more heavily than others.
Below a function, or combination of functions, can be given which will construct the relative weight given to each datapoint.
Furthermore, the type of error (MAE, MAPE, RMSE) can be defined here.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">WEIGHT_TIME</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># decrease weight with time, first point 10 times as import as last point</span>
<span class="n">WEIGHT_TIME</span> <span class="o">=</span> <span class="n">WEIGHT_TIME</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">WEIGHT_TIME</span><span class="p">)</span>  <span class="c1"># normalize</span>

<span class="k">def</span> <span class="nf">METRIC</span><span class="p">(</span><span class="n">y_true</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">y_true</span><span class="p">),</span> <span class="n">weights</span><span class="o">=</span><span class="n">WEIGHT_TIME</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (min)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">WEIGHT_TIME</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">WEIGHT_TIME</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;relative weight&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">WEIGHT_TIME</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;cumulative weight (%)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/metric_weights.png"><img alt="_images/metric_weights.png" class="align-center" src="_images/metric_weights.png" style="width: 600px;" /></a>
</section>
<section id="utilizing-normal-kinetics">
<h2>Utilizing normal kinetics<a class="headerlink" href="#utilizing-normal-kinetics" title="Permalink to this heading"></a></h2>
<p>If a chemical in the system has reached equilibrium before the end of the measurement, the steady state assumption is
valid. In some scenarios this allows us to extract the rate constant corresponding to that reaction, using
regular kinetics. In this reaction the rate of change for intermediate <span class="math notranslate nohighlight">\(3\)</span> can be described by:</p>
<div class="math notranslate nohighlight" id="equation-d3dt">
<span class="eqno">(1)<a class="headerlink" href="#equation-d3dt" title="Permalink to this equation"></a></span>\[d[3]/dt = k_1[cat][2] + k_{-2}[4] - (k_{-1} + k_2)[3]\]</div>
<p>When <span class="math notranslate nohighlight">\(3\)</span> is in steady state conditions, equation <a class="reference internal" href="#equation-d3dt">(1)</a> equals 0, and we can restructure it to:</p>
<div class="math notranslate nohighlight" id="equation-3eq">
<span class="eqno">(2)<a class="headerlink" href="#equation-3eq" title="Permalink to this equation"></a></span>\[k_1[cat][2] + k_{-2}[4] = (k_{-1} + k_2)[3]_{eq}\]</div>
<p>If the system is perturbed by e.g. the addition of a labeled compound, the rate of change is again given by <a class="reference internal" href="#equation-d3dt">(1)</a>.
We can substitute <a class="reference internal" href="#equation-3eq">(2)</a> into <a class="reference internal" href="#equation-d3dt">(1)</a>:</p>
<div class="math notranslate nohighlight" id="equation-yes">
<span class="eqno">(3)<a class="headerlink" href="#equation-yes" title="Permalink to this equation"></a></span>\[d[3]/dt = (k_{-1} + k_2)[3]_{eq} - (k_{-1} + k_2)[3] = (k_{-1} + k_2)\cdot([3]_{eq} - [3])\]</div>
<p>which can be solved analytically. However this substitution is only valid if <span class="math notranslate nohighlight">\(4\)</span> has a constant concentration or
<span class="math notranslate nohighlight">\(k_{-2}\cdot4\)</span> is negligible. The solution to this system, when normalized such that 3 + 3-labeled = 1 at equilibrium,
is given by:</p>
<div class="math notranslate nohighlight" id="equation-3t">
<span class="eqno">(4)<a class="headerlink" href="#equation-3t" title="Permalink to this equation"></a></span>\[[3]_t = [3]_{eq} \cdot (1 - e^{-(k_{-1} + k_2) \cdot t})\]</div>
<p>Hilgers et al. performed kinetic experiments that showed that <span class="math notranslate nohighlight">\(k_{-1}\)</span> equals 0, and therefore we can
straightforwardly extract <span class="math notranslate nohighlight">\(k_2\)</span> from <a class="reference internal" href="#equation-3t">(4)</a>. In code this is done as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">STEADY_STATE_CHEMICALS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;3D&#39;</span><span class="p">,</span> <span class="s1">&#39;3E&#39;</span><span class="p">,</span> <span class="s1">&#39;3F&#39;</span><span class="p">]</span>
<span class="n">EQUILIBRIUM_LAST_N</span> <span class="o">=</span> <span class="mi">500</span>

<span class="k">for</span> <span class="n">chemical</span> <span class="ow">in</span> <span class="n">STEADY_STATE_CHEMICALS</span><span class="p">:</span>
    <span class="c1"># normalize for each steady state such that chemical + chemical&#39; = 1 at equilibrium</span>
    <span class="n">y_true_curve</span> <span class="o">=</span> <span class="n">experimental</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">chemical</span><span class="si">}{</span><span class="n">LABEL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">experimental</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">-</span><span class="n">EQUILIBRIUM_LAST_N</span><span class="p">:,</span> <span class="p">[</span><span class="n">chemical</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">chemical</span><span class="si">}{</span><span class="n">LABEL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">y_true_curve</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">EQUILIBRIUM_LAST_N</span><span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="o">-</span><span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="n">MAE_f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">METRIC</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">y_true_curve</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">MAE_f</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">chemical</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

    <span class="c1"># show best fit</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">chemical</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;MAE: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">fun</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">time</span><span class="p">[:</span><span class="o">-</span><span class="n">EQUILIBRIUM_LAST_N</span><span class="p">],</span> <span class="n">y_true_curve</span><span class="p">[:</span><span class="o">-</span><span class="n">EQUILIBRIUM_LAST_N</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="n">EQUILIBRIUM_LAST_N</span><span class="p">:],</span> <span class="n">y_true_curve</span><span class="p">[</span><span class="o">-</span><span class="n">EQUILIBRIUM_LAST_N</span><span class="p">:],</span><span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:green&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;DRL&#39;</span><span class="p">)</span>  <span class="c1"># clearer legend</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;DRL-eq&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (min)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;intensity (a.u.)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># analyze sensitivity to deviations</span>
    <span class="n">rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">MAE_f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rates</span><span class="p">])</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">errors</span> <span class="o">&lt;</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">fun</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">errors</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">result</span><span class="o">.</span><span class="n">fun</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;best fit, k: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>
    <span class="n">bounds_10pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">errors</span><span class="o">&lt;</span><span class="mf">1.1</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">fun</span><span class="p">)[</span><span class="mi">0</span><span class="p">][[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">bounds_10pc</span><span class="p">],</span> <span class="n">errors</span><span class="p">[</span><span class="n">bounds_10pc</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
               <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;+10% MAE:</span><span class="se">\n</span><span class="s1">[</span><span class="si">{</span><span class="n">rates</span><span class="p">[</span><span class="n">bounds_10pc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">rates</span><span class="p">[</span><span class="n">bounds_10pc</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;value of rate constant&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/kinetics.png"><img alt="_images/kinetics.png" class="align-center" src="_images/kinetics.png" style="width: 600px;" /></a>
<p>Similar graphs were made for isomers E and F, although the larger amount of noise in F allowed for a large range of values in which
the rate constant yielded an acceptable error. The found range where the error increased up to 10% compared to its minimum error
for 3E was [0.675 - 0.934], and for 3F [0.242 - 1.228].</p>
</section>
<section id="defining-the-model">
<h2>Defining the model<a class="headerlink" href="#defining-the-model" title="Permalink to this heading"></a></h2>
<p>The chemical system can be described by the following reaction steps. The chemicals that have a labeled counterpart
are marked with {label} such that we do not have to write it out twice. We only define the forwards reactions, and
afterwards loop over each reaction to create its backwards reaction by reversing the <code class="docutils literal notranslate"><span class="pre">reactants</span></code> and <code class="docutils literal notranslate"><span class="pre">products</span></code>,
and inserting a <code class="docutils literal notranslate"><span class="pre">-</span></code> into the name of the rate constant..</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">REACTIONS_ONEWAY</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">LABEL</span><span class="p">]:</span>
    <span class="n">REACTIONS_ONEWAY</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
        <span class="p">(</span><span class="s2">&quot;k1_D&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;2</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">],</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;3D</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;k1_E&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;2</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">],</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;3E</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;k1_F&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;2</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">],</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;3F</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">]),</span>

        <span class="p">(</span><span class="s2">&quot;k2_D&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;3D</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">],</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;4D</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;k2_E&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;3E</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">],</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;4E</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;k2_F&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;3F</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">],</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;4F</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">]),</span>

        <span class="p">(</span><span class="s2">&quot;k3_D&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;4D</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">],</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;5D</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;k3_E&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;4E</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">],</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;5E</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;k3_F&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;4F</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">],</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;5F</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">]),</span>

        <span class="p">(</span><span class="s2">&quot;k4_D&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;5D</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">],</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;6D</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;k4_E&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;5E</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">],</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;6E</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;k4_F&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;5F</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">],</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;6F</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="p">]),</span>
    <span class="p">])</span>

<span class="n">reactions</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">REACTIONS_ONEWAY</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">reactants</span><span class="p">,</span> <span class="n">products</span> <span class="ow">in</span> <span class="n">REACTIONS_ONEWAY</span><span class="p">:</span>
    <span class="n">reactions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;k-&quot;</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">products</span><span class="p">,</span> <span class="n">reactants</span><span class="p">))</span>  <span class="c1"># &#39;kABC&#39; reactants, products -&gt; &#39;k-ABC&#39;, products, reactants</span>
<span class="n">rate_constant_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">reactions</span><span class="p">]))</span>

<span class="c1"># these groups will make the analysis easier</span>
<span class="n">ISOMERS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">]</span>
<span class="n">INTERMEDIATES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4/5&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>The next step is to the create our RateConstantOptimizer class. We will apply three different kinds of error metrics.</p>
<ol class="arabic simple">
<li><p>label ratio: The ratio of e.g. 3D / (3D+3D’), the typical DRL curve.</p></li>
<li><p>isomer ratio: The ratio of e.g. 3D / (3D + 3E + 3F).</p></li>
<li><p>TIC shape: how well the curve represent the shape of the TIC curve.</p></li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is important to note that we should not fit on the TIC if the data has been normalized with respect to the TIC,
because in that case the intensity of a chemical is not necessarily proporional to the concentration.
This is only a concern when the TIC changes over time.</p>
</div>
<p>We will apply weights to each type of error to make sure that the system prioritizes getting the label ratio right, but
would see it as a benefit if the isomer ratio also fits well. We will see later that in the optimized model, the three
different kinds kinds of error contribute in roughly equal amount to the total error. The weight of all isomers F has been
decreased to account for the larger amount of noise in this data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>  <span class="c1"># compatibility with 3.8</span>
<span class="n">WEIGHTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ratio_label&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;ratio_isomer&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="s2">&quot;TIC&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
    <span class="s2">&quot;iso_F&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
<span class="p">}</span>
<span class="c1"># By putting it outside the function, we can store in the metadata of each optimization process.</span>
<span class="n">CONCENTRATIONS_INITIAL</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cat&quot;</span><span class="p">:</span> <span class="mf">0.005</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">/</span> <span class="mi">1200</span><span class="p">,</span>  <span class="c1"># concentration in M</span>
                          <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="mf">0.005</span> <span class="o">*</span> <span class="mi">800</span> <span class="o">/</span> <span class="mi">1200</span><span class="p">}</span>
<span class="n">CONCENTRATION_LABELED_REACTANT</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;2&#39;&quot;</span><span class="p">:</span> <span class="mf">0.005</span> <span class="o">*</span> <span class="mi">800</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">}</span>
<span class="n">DILUTION_FACTOR</span> <span class="o">=</span> <span class="mi">1200</span> <span class="o">/</span> <span class="mi">2000</span>

<span class="k">class</span> <span class="nc">RateConstantOptimizer</span><span class="p">(</span><span class="n">RateConstantOptimizerTemplate</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_prediction</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x_description</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="c1"># separate out the ionization factor from the other parameters which are being optimized.</span>
        <span class="n">rate_constants</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">rate_constant_names</span><span class="p">)],</span> <span class="n">index</span><span class="o">=</span><span class="n">x_description</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">rate_constant_names</span><span class="p">)])</span>
        <span class="n">ionization_factor</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">drl</span> <span class="o">=</span> <span class="n">DRL</span><span class="p">(</span><span class="n">reactions</span><span class="o">=</span><span class="n">reactions</span><span class="p">,</span>
                  <span class="n">rate_constants</span><span class="o">=</span><span class="n">rate_constants</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">prediction_labeled</span> <span class="o">=</span> <span class="n">drl</span><span class="o">.</span><span class="n">predict_concentration</span><span class="p">(</span>
            <span class="n">t_eval_pre</span><span class="o">=</span><span class="n">time_pre</span><span class="p">,</span>
            <span class="n">t_eval_post</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
            <span class="n">initial_concentrations</span><span class="o">=</span><span class="n">CONCENTRATIONS_INITIAL</span><span class="p">,</span>
            <span class="n">labeled_concentration</span><span class="o">=</span><span class="n">CONCENTRATION_LABELED_REACTANT</span><span class="p">,</span>
            <span class="n">dilution_factor</span><span class="o">=</span><span class="n">DILUTION_FACTOR</span><span class="p">,</span>
            <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
            <span class="n">atol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">)</span>

        <span class="c1"># SYSTEM-SPECIFIC ENAMINE IONIZATION CORRECTION -&gt; only a prediction of 4 and 5 together can be made!</span>
        <span class="c1"># this because the unstable enamine will ionize to the iminium ion upon injection in the mass spectrometer.</span>
        <span class="k">for</span> <span class="n">isomer</span> <span class="ow">in</span> <span class="n">ISOMERS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">]:</span>
                <span class="n">prediction_labeled</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sa">f</span><span class="s2">&quot;4/5</span><span class="si">{</span><span class="n">isomer</span><span class="si">}{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prediction_labeled</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sa">f</span><span class="s2">&quot;5</span><span class="si">{</span><span class="n">isomer</span><span class="si">}{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> \
                    <span class="o">+</span> <span class="n">ionization_factor</span> <span class="o">*</span> <span class="n">prediction_labeled</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sa">f</span><span class="s2">&quot;4</span><span class="si">{</span><span class="n">isomer</span><span class="si">}{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">prediction_labeled</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_curves</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="n">curves</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">intermediate</span> <span class="ow">in</span> <span class="n">INTERMEDIATES</span><span class="p">:</span>
            <span class="c1"># sum does not have to be recalculated between the isomer runs</span>
            <span class="n">sum_all_isomers</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">intermediate</span><span class="si">}{</span><span class="n">isomer</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">isomer</span> <span class="ow">in</span> <span class="n">ISOMERS</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">isomer</span> <span class="ow">in</span> <span class="n">ISOMERS</span><span class="p">:</span>
                <span class="n">chemical</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate</span><span class="si">}{</span><span class="n">isomer</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># 3D, 3E, 3F, 4/5D, 4/5E, 3/5F</span>
                <span class="c1"># allows for easy modification of weight. str.contains(&#39;int_1&#39;) is much more specific than just &#39;1&#39;</span>
                <span class="n">chemical_iso_split</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;int_</span><span class="si">{</span><span class="n">intermediate</span><span class="si">}</span><span class="s2">_iso_</span><span class="si">{</span><span class="n">isomer</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">sum_chemical</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="n">chemical</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">chemical</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">curves</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ratio_label_</span><span class="si">{</span><span class="n">chemical_iso_split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>  <span class="c1"># 3D / (3D+3D&#39;)</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">chemical</span><span class="p">]</span> <span class="o">/</span> <span class="n">sum_chemical</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">curves</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ratio_isomer_</span><span class="si">{</span><span class="n">chemical_iso_split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>  <span class="c1"># 3D / (3D+3E+3F)</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">chemical</span><span class="p">]</span> <span class="o">/</span> <span class="n">sum_all_isomers</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">curves</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;TIC-normal_</span><span class="si">{</span><span class="n">chemical_iso_split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>  <span class="c1"># normalized TIC curve</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">chemical</span><span class="p">]</span> <span class="o">/</span> <span class="n">sum_chemical</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">curves</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;TIC-labeled_</span><span class="si">{</span><span class="n">chemical_iso_split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>  <span class="c1"># normalized TIC curve</span>
                        <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">chemical</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">sum_chemical</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">curves</span>

    <span class="k">def</span> <span class="nf">weigh_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errors</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="n">weighed_errors</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">weigh_errors</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

        <span class="c1"># perform the usual behavior of this function, but also perform an additional check with regards to the output!</span>
        <span class="n">TIC_sum</span> <span class="o">=</span> <span class="n">weighed_errors</span><span class="p">[</span><span class="n">weighed_errors</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;TIC-&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">label_sum</span> <span class="o">=</span> <span class="n">weighed_errors</span><span class="p">[</span><span class="n">weighed_errors</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;label_&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">isomer_sum</span> <span class="o">=</span> <span class="n">weighed_errors</span><span class="p">[</span><span class="n">weighed_errors</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;isomer_&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">TIC_sum</span> <span class="o">+</span> <span class="n">label_sum</span> <span class="o">+</span> <span class="n">isomer_sum</span>
        <span class="n">ratios</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">TIC_sum</span><span class="o">/</span><span class="n">total</span><span class="p">,</span> <span class="n">label_sum</span><span class="o">/</span><span class="n">total</span><span class="p">,</span> <span class="n">isomer_sum</span><span class="o">/</span><span class="n">total</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;TIC&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">ratios</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">ratios</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;One of the error metrics is either way smaller, or way larger than the others</span><span class="se">\n</span><span class="si">{</span><span class="n">ratios</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">weighed_errors</span>

<span class="n">RCO</span> <span class="o">=</span> <span class="n">RateConstantOptimizer</span><span class="p">(</span><span class="n">experimental</span><span class="o">=</span><span class="n">experimental</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">METRIC</span><span class="p">,</span> <span class="n">raw_weights</span><span class="o">=</span><span class="n">WEIGHTS</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="optimizing-the-model">
<h2>Optimizing the model<a class="headerlink" href="#optimizing-the-model" title="Permalink to this heading"></a></h2>
<p>To optimize the model we need to first define the bounds and starting position of the system. To conveniently manipulate
the bounds and x0 of each parameter, we construct a DataFrame. In this DataFrame each row belongs to a different
parameter, and the columns describe x0, lower boundary, and upper boundary.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dimension_descriptions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rate_constant_names</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;ion&quot;</span><span class="p">]</span>
<span class="n">constraints</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">dimension_descriptions</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
                           <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">],</span>
                           <span class="n">index</span><span class="o">=</span><span class="n">dimension_descriptions</span><span class="p">)</span>

<span class="n">index_reverse_reaction</span> <span class="o">=</span> <span class="n">constraints</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;k-&quot;</span><span class="p">)</span>
<span class="n">constraints</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">index_reverse_reaction</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="mf">1e2</span><span class="p">]</span>  <span class="c1"># forwards; vertex, lower, upper</span>
<span class="n">constraints</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">index_reverse_reaction</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1e2</span><span class="p">]</span>    <span class="c1"># backwards</span>
<span class="c1"># newer versions of pandas could also use:</span>
<span class="c1"># constraints[~index_reverse_reaction] = [1, 1e-9, 1e2]</span>

<span class="c1"># special case</span>
<span class="n">constraints</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">constraints</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;ion&quot;</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">constraints</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">constraints</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;k2_D&quot;</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.441673</span><span class="p">,</span> <span class="mf">0.4160</span><span class="p">,</span> <span class="mf">0.4780</span><span class="p">]</span>
<span class="n">constraints</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">constraints</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;k2_E&quot;</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.782919</span><span class="p">,</span> <span class="mf">0.6747</span><span class="p">,</span> <span class="mf">0.9335</span><span class="p">]</span>
<span class="n">constraints</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">constraints</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;k2_F&quot;</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.464105</span><span class="p">,</span> <span class="mf">0.2418</span><span class="p">,</span> <span class="mf">1.2277</span><span class="p">]</span>

<span class="c1"># either chemically or experimentally determined to be zero</span>
<span class="n">constraints</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">constraints</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;k-1&quot;</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">constraints</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">constraints</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;k-3&quot;</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">constraints</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">constraints</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;k-4&quot;</span><span class="p">))]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;x0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="n">Bounds</span><span class="p">(</span><span class="n">constraints</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">constraints</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
</pre></div>
</div>
<p>We can optimize the system once like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./optimization/&#39;</span>
<span class="n">RCO</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span>
    <span class="n">x_description</span><span class="o">=</span><span class="n">dimension_descriptions</span><span class="p">,</span>
    <span class="n">x_bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
    <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
    <span class="n">maxiter</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span>  <span class="c1"># this might take a while ...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Or multiple times:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RCO</span><span class="o">.</span><span class="n">optimize_multiple</span><span class="p">(</span>
    <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./optimization_multiple/&#39;</span><span class="p">,</span>
    <span class="n">n_runs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>  <span class="c1"># This take a long while ...</span>
    <span class="n">x_description</span><span class="o">=</span><span class="n">dimension_descriptions</span><span class="p">,</span>
    <span class="n">x_bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
    <span class="n">maxiter</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>   <span class="c1"># uses all but 1 cpu cores available; this took a day or 2 ...</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="visualize">
<span id="extensivevisuals"></span><h2>Visualize<a class="headerlink" href="#visualize" title="Permalink to this heading"></a></h2>
<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">visualize.VisualizeSingleModel</span></code> can be used to make various kinds of plots.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">delayed_reactant_labeling.optimize</span> <span class="kn">import</span> <span class="n">OptimizedMultipleModels</span>
<span class="kn">from</span> <span class="nn">delayed_reactant_labeling.visualize</span> <span class="kn">import</span> <span class="n">VisualizeModel</span>

<span class="n">models</span> <span class="o">=</span> <span class="n">OptimizedMultipleModels</span><span class="p">(</span><span class="s1">&#39;./optimization_multiple&#39;</span><span class="p">)</span>

<span class="n">VM</span> <span class="o">=</span> <span class="n">VisualizeModel</span><span class="p">(</span>
    <span class="n">image_path</span><span class="o">=</span><span class="s1">&#39;./images/&#39;</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">best</span><span class="p">,</span>  <span class="c1"># this assumption would be made automatically, but raises a warning</span>
    <span class="n">models</span><span class="o">=</span><span class="n">models</span><span class="p">,</span>
    <span class="n">rate_constant_optimizer</span><span class="o">=</span><span class="n">RCO</span><span class="p">,</span>
    <span class="n">hide_params</span><span class="o">=</span><span class="n">constraints</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">extensions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;svg&#39;</span><span class="p">],</span> <span class="n">overwrite_image</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># having a leading &#39;.&#39; does not matter</span>
</pre></div>
</div>
<section id="model-progression">
<h3>Model progression<a class="headerlink" href="#model-progression" title="Permalink to this heading"></a></h3>
<p>The ratio of 6D to 6D + 6E can be plotted together with the error of the model as a function of the iteration number.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">VM</span><span class="o">.</span><span class="n">plot_optimization_progress</span><span class="p">(</span><span class="n">ratio</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;6D&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;6D&#39;</span><span class="p">,</span> <span class="s1">&#39;6E&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/plot_optimization_progress.png"><img alt="_images/plot_optimization_progress.png" class="align-center" src="_images/plot_optimization_progress.png" style="width: 640px;" /></a>
<p>We can plot its path through a dimensionally reduced space as follows:
The figsize keyword is supplied to ensure that the figure is square.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">VM</span><span class="o">.</span><span class="n">plot_path_in_pca</span><span class="p">(</span><span class="n">pc1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pc2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mf">6.4</span><span class="p">))</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/plot_path_in_pca.png"><img alt="_images/plot_path_in_pca.png" class="align-center" src="_images/plot_path_in_pca.png" style="width: 640px;" /></a>
</section>
<section id="model-output">
<h3>Model output<a class="headerlink" href="#model-output" title="Permalink to this heading"></a></h3>
<p>The found rate constants can easily be plotted using the <code class="docutils literal notranslate"><span class="pre">plot_grouped_by</span></code> function. From this we can see
that there are large deviations compared to the constants that Hilgers found. See the section <a class="reference internal" href="#visualize-multiple"><span class="std std-ref">Multiple guesses</span></a>
for a more in depth comparison for the models that have been found.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rate_constants_Hilgers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span>
    <span class="s1">&#39;k1_D&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>    <span class="s1">&#39;k1_E&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>   <span class="s1">&#39;k1_F&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="s1">&#39;k2_D&#39;</span><span class="p">:</span> <span class="mf">0.43</span><span class="p">,</span>   <span class="s1">&#39;k2_E&#39;</span><span class="p">:</span> <span class="mf">0.638</span><span class="p">,</span>  <span class="s1">&#39;k2_F&#39;</span><span class="p">:</span> <span class="mf">0.567</span><span class="p">,</span>
    <span class="s1">&#39;k3_D&#39;</span><span class="p">:</span> <span class="mf">0.23</span><span class="p">,</span>   <span class="s1">&#39;k3_E&#39;</span><span class="p">:</span> <span class="mf">0.35</span><span class="p">,</span>   <span class="s1">&#39;k3_F&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
    <span class="s1">&#39;k4_D&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>      <span class="s1">&#39;k4_E&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>   <span class="s1">&#39;k4_F&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span>
    <span class="s1">&#39;k-1_D&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>     <span class="s1">&#39;k-1_E&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>     <span class="s1">&#39;k-1_F&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;k-2_D&#39;</span><span class="p">:</span> <span class="mf">0.025</span><span class="p">,</span> <span class="s1">&#39;k-2_E&#39;</span><span class="p">:</span> <span class="mf">0.035</span><span class="p">,</span> <span class="s1">&#39;k-2_F&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span>
    <span class="s1">&#39;k-3_D&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>     <span class="s1">&#39;k-3_E&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>     <span class="s1">&#39;k-3_F&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;k-4_D&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>     <span class="s1">&#39;k-4_E&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>     <span class="s1">&#39;k-4_F&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;ion&#39;</span><span class="p">:</span> <span class="mf">0.025</span><span class="p">,</span>
<span class="p">},</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Hilgers&#39;</span><span class="p">)</span>

<span class="n">VM</span><span class="o">.</span><span class="n">plot_grouped_by</span><span class="p">(</span>
    <span class="n">VM</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">optimal_x</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">),</span>
    <span class="n">rate_constants_Hilgers</span><span class="p">,</span>
    <span class="n">group_by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;k1_&#39;</span><span class="p">,</span> <span class="s1">&#39;k2_&#39;</span><span class="p">,</span> <span class="s1">&#39;k3_&#39;</span><span class="p">,</span> <span class="s1">&#39;k4_&#39;</span><span class="p">,</span> <span class="s1">&#39;k-2&#39;</span><span class="p">,</span> <span class="s1">&#39;ion&#39;</span><span class="p">],</span>
    <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;plot_x&#39;</span><span class="p">,</span> <span class="n">xtick_rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">show_remaining</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/plot_x.png"><img alt="_images/plot_x.png" class="align-center" src="_images/plot_x.png" style="width: 640px;" /></a>
<p>The errors of the model can also be plotted using the <code class="docutils literal notranslate"><span class="pre">plot_grouped_by</span></code> function.
The total error of the model is 0.195 (model_weighed_errors.sum()), which is approximately 83% of the error found by
Hilgers. However, they did not put the same weights on the these parameters, so it is logical that their fit will be
different. See <a class="reference internal" href="#visualize-error-curves"><span class="std std-ref">Error curves</span></a> for detailed insights into the shapes of the curves, that define these
errors.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model_pred</span> <span class="o">=</span> <span class="n">RCO</span><span class="o">.</span><span class="n">create_prediction</span><span class="p">(</span><span class="n">VM</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">optimal_x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">VM</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">optimal_x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">model_weighed_errors</span> <span class="o">=</span> <span class="n">RCO</span><span class="o">.</span><span class="n">weigh_errors</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="n">RCO</span><span class="o">.</span><span class="n">calculate_errors</span><span class="p">(</span><span class="n">model_pred</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>

<span class="n">Hilgers_pred</span> <span class="o">=</span> <span class="n">RCO</span><span class="o">.</span><span class="n">create_prediction</span><span class="p">(</span><span class="n">rate_constants_Hilgers</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">rate_constants_Hilgers</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">Hilgers_weighed_errors</span> <span class="o">=</span> <span class="n">RCO</span><span class="o">.</span><span class="n">weigh_errors</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="n">RCO</span><span class="o">.</span><span class="n">calculate_errors</span><span class="p">(</span><span class="n">Hilgers_pred</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;Hilgers&#39;</span><span class="p">)</span>

<span class="n">VM</span><span class="o">.</span><span class="n">plot_grouped_by</span><span class="p">(</span>
    <span class="n">model_weighed_errors</span><span class="p">,</span>
    <span class="n">Hilgers_weighed_errors</span><span class="p">,</span>
    <span class="n">group_by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ratio_label&#39;</span><span class="p">,</span> <span class="s1">&#39;ratio_isomer&#39;</span><span class="p">,</span> <span class="s1">&#39;TIC-normal&#39;</span><span class="p">,</span> <span class="s1">&#39;TIC-labeled&#39;</span><span class="p">],</span> <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;plot_errors&#39;</span><span class="p">,</span> <span class="n">xtick_rotation</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;col&#39;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/plot_errors.png"><img alt="_images/plot_errors.png" class="align-center" src="_images/plot_errors.png" style="width: 640px;" /></a>
<p>The percentage of chemicals which belong to pathway D or E can be plotted as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">VM</span><span class="o">.</span><span class="n">plot_enantiomer_ratio</span><span class="p">(</span>
    <span class="n">group_by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4/5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">],</span>
    <span class="n">ratio_of</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">],</span>
    <span class="n">experimental</span><span class="o">=</span><span class="n">experimental</span><span class="p">,</span>
    <span class="n">prediction</span><span class="o">=</span><span class="n">model_pred</span><span class="p">,</span>
    <span class="n">warn_label_assumption</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">VM</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="s1">&#39;plot_enantiomer_ratio&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Because both the labeled compound and the non-labeled compound have very similar names, (3D vs 3D’), we know
that the identifiers given in <code class="docutils literal notranslate"><span class="pre">group_by</span></code> and <code class="docutils literal notranslate"><span class="pre">ratio_of</span></code> wont be able to seperate these two cases from each other.
However, the shortest name will be used in the calculation as this is most likely the non-labeled compound.
The corresponding warning which is emitted can be ignored by setting the flag <code class="docutils literal notranslate"><span class="pre">warn_label_assumption</span></code>,
to False. It is fine to plot only the ratios for the non-labeled compounds as the ratio between isomers should be
identical for the non-labeled and labeled compounds.</p>
<a class="reference internal image-reference" href="_images/plot_enantiomer_ratio.png"><img alt="_images/plot_enantiomer_ratio.png" class="align-center" src="_images/plot_enantiomer_ratio.png" style="width: 640px;" /></a>
</section>
<section id="heat-maps">
<h3>Heat maps<a class="headerlink" href="#heat-maps" title="Permalink to this heading"></a></h3>
<p>The changes in the parameters can be plotted over time by using a heatmap as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">VM</span><span class="o">.</span><span class="n">plot_rate_over_time</span><span class="p">(</span><span class="n">log_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">x_min</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/plot_rate_over_time.png"><img alt="_images/plot_rate_over_time.png" class="align-center" src="_images/plot_rate_over_time.png" style="width: 640px;" /></a>
<p>The sensitivity of the model, for each parameter with respect to a change in its value, can be shown as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">VM</span><span class="o">.</span><span class="n">plot_rate_sensitivity</span><span class="p">(</span><span class="n">x_min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">x_max</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span> <span class="n">max_error</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/plot_rate_sensitivity.png"><img alt="_images/plot_rate_sensitivity.png" class="align-center" src="_images/plot_rate_sensitivity.png" style="width: 640px;" /></a>
</section>
<section id="error-curves">
<span id="visualize-error-curves"></span><h3>Error curves<a class="headerlink" href="#error-curves" title="Permalink to this heading"></a></h3>
<p>We can visualize the curves that are used for the calculation of the error as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_curves</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;if errors are given, give each line a label including the error for that curve&quot;&quot;&quot;</span>
    <span class="n">plot_label</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">errors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">intermediate</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">INTERMEDIATES</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">isomer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ISOMERS</span><span class="p">):</span>
            <span class="n">chemical_iso_split</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;int_</span><span class="si">{</span><span class="n">intermediate</span><span class="si">}</span><span class="s2">_iso_</span><span class="si">{</span><span class="n">isomer</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">chemical</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">intermediate</span><span class="si">}{</span><span class="n">isomer</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># plot label ratio, the curve of the labeled compound is the same, by definition, as 1 - unlabeled</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">chemical</span><span class="si">}</span><span class="s2"> MAE: </span><span class="si">{</span><span class="n">errors</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;ratio_label_</span><span class="si">{</span><span class="n">chemical_iso_split</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">plot_label</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">axs_label</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ratio_label_</span><span class="si">{</span><span class="n">chemical_iso_split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
            <span class="n">axs_label</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ratio_label_</span><span class="si">{</span><span class="n">chemical_iso_split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:gray&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>

            <span class="c1"># isomer ratio</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">chemical</span><span class="si">}</span><span class="s2"> MAE: </span><span class="si">{</span><span class="n">errors</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;ratio_isomer_</span><span class="si">{</span><span class="n">chemical_iso_split</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">plot_label</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">axs_isomer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ratio_isomer_</span><span class="si">{</span><span class="n">chemical_iso_split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>

            <span class="c1"># TIC shape</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">chemical</span><span class="si">}</span><span class="s2"> MAE: </span><span class="si">{</span><span class="n">errors</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;TIC-normal_</span><span class="si">{</span><span class="n">chemical_iso_split</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">plot_label</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">axs_TIC</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;TIC-normal_</span><span class="si">{</span><span class="n">chemical_iso_split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>

            <span class="c1"># TIC labeled shape</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">chemical</span><span class="si">}{</span><span class="n">LABEL</span><span class="si">}</span><span class="s2"> MAE: </span><span class="si">{</span><span class="n">errors</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;TIC-labeled_</span><span class="si">{</span><span class="n">chemical_iso_split</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">plot_label</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">axs_TIC</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;TIC-labeled_</span><span class="si">{</span><span class="n">chemical_iso_split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>

<span class="c1"># manual plot of curves</span>
<span class="n">fig_label</span><span class="p">,</span> <span class="n">axs_label</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axs_label</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;label ratio&#39;</span><span class="p">)</span>
<span class="n">fig_isomer</span><span class="p">,</span> <span class="n">axs_isomer</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axs_isomer</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;isomer ratio&#39;</span><span class="p">)</span>
<span class="n">fig_TIC</span><span class="p">,</span> <span class="n">axs_TIC</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axs_TIC</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;TIC shape&#39;</span><span class="p">)</span>

<span class="c1"># experimental</span>
<span class="n">plot_curves</span><span class="p">(</span><span class="n">VM</span><span class="o">.</span><span class="n">RCO</span><span class="o">.</span><span class="n">experimental_curves</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="c1"># best model</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">VM</span><span class="o">.</span><span class="n">RCO</span><span class="o">.</span><span class="n">create_prediction</span><span class="p">(</span><span class="n">VM</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">optimal_x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">VM</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">optimal_x</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">curves</span> <span class="o">=</span> <span class="n">VM</span><span class="o">.</span><span class="n">RCO</span><span class="o">.</span><span class="n">calculate_curves</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
<span class="n">errors</span> <span class="o">=</span> <span class="n">VM</span><span class="o">.</span><span class="n">RCO</span><span class="o">.</span><span class="n">weigh_errors</span><span class="p">(</span><span class="n">VM</span><span class="o">.</span><span class="n">RCO</span><span class="o">.</span><span class="n">calculate_errors</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span>
<span class="n">plot_curves</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

<span class="c1"># Hilgers model</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">VM</span><span class="o">.</span><span class="n">RCO</span><span class="o">.</span><span class="n">create_prediction</span><span class="p">(</span><span class="n">rate_constants_Hilgers</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">rate_constants_Hilgers</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">curves</span> <span class="o">=</span> <span class="n">VM</span><span class="o">.</span><span class="n">RCO</span><span class="o">.</span><span class="n">calculate_curves</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
<span class="n">errors</span> <span class="o">=</span> <span class="n">VM</span><span class="o">.</span><span class="n">RCO</span><span class="o">.</span><span class="n">weigh_errors</span><span class="p">(</span><span class="n">VM</span><span class="o">.</span><span class="n">RCO</span><span class="o">.</span><span class="n">calculate_errors</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span>
<span class="n">plot_curves</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">axs_label</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">axs_isomer</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">axs_TIC</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">VM</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">fig_label</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">)</span>
<span class="n">VM</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">fig_isomer</span><span class="p">,</span> <span class="s1">&#39;isomer&#39;</span><span class="p">)</span>
<span class="n">VM</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">fig_TIC</span><span class="p">,</span> <span class="s1">&#39;TIC&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The data of Hilgers will be plotted as a dashed line, whereas the found curves will be plotted with a full line.</p>
<a class="reference internal image-reference" href="_images/label.png"><img alt="_images/label.png" class="align-center" src="_images/label.png" style="width: 640px;" /></a>
<a class="reference internal image-reference" href="_images/isomer.png"><img alt="_images/isomer.png" class="align-center" src="_images/isomer.png" style="width: 640px;" /></a>
<a class="reference internal image-reference" href="_images/TIC.png"><img alt="_images/TIC.png" class="align-center" src="_images/TIC.png" style="width: 1200px;" /></a>
</section>
<section id="multiple-guesses">
<span id="visualize-multiple"></span><h3>Multiple guesses<a class="headerlink" href="#multiple-guesses" title="Permalink to this heading"></a></h3>
<p>The following plots can be made for multiple optimization processes only.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">VM</span><span class="o">.</span><span class="n">plot_error_all_runs</span><span class="p">()</span>
<span class="n">VM</span><span class="o">.</span><span class="n">plot_error_all_runs</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;plot_error_all_runs_zoom_in&#39;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/plot_error_all_runs.png"><img alt="_images/plot_error_all_runs.png" class="align-center" src="_images/plot_error_all_runs.png" style="width: 640px;" /></a>
<a class="reference internal image-reference" href="_images/plot_error_all_runs_zoom_in.png"><img alt="_images/plot_error_all_runs_zoom_in.png" class="align-center" src="_images/plot_error_all_runs_zoom_in.png" style="width: 640px;" /></a>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">VM</span><span class="o">.</span><span class="n">plot_ratio_all_runs</span><span class="p">(</span><span class="n">ratio</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;6D&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;6D&#39;</span><span class="p">,</span> <span class="s1">&#39;6E&#39;</span><span class="p">]),</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/plot_ratio_all_runs.png"><img alt="_images/plot_ratio_all_runs.png" class="align-center" src="_images/plot_ratio_all_runs.png" style="width: 640px;" /></a>
<p>We can check out the distribution of the rate constants for the best plateau as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">VM</span><span class="o">.</span><span class="n">plot_x_all_runs</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/best.png"><img alt="_images/best.png" class="align-center" src="_images/best.png" style="width: 640px;" /></a>
<p>Because there are three main plateaus, and the figure above shows minimal variation within a  plateau (same for the other
plateaus, not shown here), we can just take a model for each plateau and compare them:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">VM</span><span class="o">.</span><span class="n">plot_grouped_by</span><span class="p">(</span>
    <span class="n">models</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">optimal_x</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;model_0&#39;</span><span class="p">),</span>
    <span class="n">rate_constants_Hilgers</span><span class="p">,</span>
    <span class="n">models</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">optimal_x</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;model_8&#39;</span><span class="p">),</span>
    <span class="n">models</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">optimal_x</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;model_15&#39;</span><span class="p">),</span>
    <span class="n">group_by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;k1_&#39;</span><span class="p">,</span> <span class="s1">&#39;k2_&#39;</span><span class="p">,</span> <span class="s1">&#39;k3_&#39;</span><span class="p">,</span> <span class="s1">&#39;k4_&#39;</span><span class="p">,</span> <span class="s1">&#39;k-2&#39;</span><span class="p">,</span> <span class="s1">&#39;ion&#39;</span><span class="p">],</span>
    <span class="n">show_remaining</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;x_comparison_multiple_models&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">VM</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="s1">&#39;x_comparison_multiple_models&#39;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/x_comparison_multiple_models.png"><img alt="_images/x_comparison_multiple_models.png" class="align-center" src="_images/x_comparison_multiple_models.png" style="width: 640px;" /></a>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">VM</span><span class="o">.</span><span class="n">plot_biplot_all_runs</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/plot_biplot_all_runs.png"><img alt="_images/plot_biplot_all_runs.png" class="align-center" src="_images/plot_biplot_all_runs.png" style="width: 640px;" /></a>
<p>Because we had three main plateaus in the optimal 20 runs, we only see 3 unique optimal points in the biplot.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="visualize.html" class="btn btn-neutral float-left" title="Visualize" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="design_choices.html" class="btn btn-neutral float-right" title="Implementation details" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Martijn Dingemans.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>